<!DOCTYPE html>
<html class=" ">
{% include 'header.html' %}
<head> </head>
<body class="">
  {% include 'left.html' %}
<main>
    {% include 'banner.html' %}
    <div class="container-fluid">
        <h1 class="bread-crumb"> <strong>扫描结果</strong>
            <div class="absolute-right">
                <form action="" method="post" class="input-group search-group" data-format="HTML" data-action="notpjax">
                    
                </form>
            </div> </h1>
        <table class="table table-hover" id="scan_result">
            <thead>
            <tr>
                <th>task_id</th>
                <th>target</th>
                <th>state</th>
                <th>action</th>
                
            </tr>
            
            </thead>
            <tbody id="resulist">

            </tbody>
        </table>
    </div>
</main>

<script>
var task_id=new Array();
var target;
var interval1;
var num;
var state=new Array();
   function show_result(){
    var str='{{result|safe}}';
    var result_dic=jQuery.parseJSON(str);
    var i=0;
    for (var key in result_dic){
        task_id[i]=key;
        i++;
    }
    num=task_id.length;
    $("#resulist").empty();
    for(var j=0;j<num;j++){
        $.ajax(
            {
                url: "/task_status/"+task_id[j],
                async:false,
                success: function (result) {
                    var task_status=jQuery.parseJSON(result);
                    if(task_status[0]=="finished"){
                        //target=result[1][0];
                        if(task_status[1][1]=='success'){
                           var tr='<tr><th>'+task_id[j]+'</th><th>'+task_status[2]+'</th><th>'+task_status[0]+'</th><th><a data="'+task_id[j]+'" href="result/'+task_id[j]+'" style="color:red">查看(漏洞)</a></th></tr>'; 
                        }
                        else{
                            var tr='<tr><th>'+task_id[j]+'</th><th>'+task_status[2]+'</th><th>'+task_status[0]+'</th><th><a data="'+task_id[j]+'" href="result/'+task_id[j]+'" style="color:green">查看</a></th></tr>';
                        }
                    
                    $("#resulist").append(tr);
                    state[task_id[j]]=task_status[0];
                    }
                    else{
                        //target=result[1];
                        var tr='<tr class="unfinish'+j+'"><th>'+task_id[j]+'</th><th>'+task_status[1]+'</th><th>'+task_status[0]+'</th><th><a data="'+task_id[j]+'" style="color:#3333FF">未完成</a></th></tr>';
                        $("#resulist").prepend(tr);
                        state[task_id[j]]=task_status[0];
                    }
                    
                },
                error:function () {
                    alert('ajax get_mods request error');
                }

            }
        )
    }
   }
   function show_unfinish_result(){
    for(var i=0;i<num;i++){
        if(state[task_id[i]]=="processing"){
            $.ajax(
            {
                url: "/task_status/"+task_id[i],
                async:false,
                success: function (result) {
                    var task_status=jQuery.parseJSON(result);
                    if(task_status[0]=="finished"){
                        //target=result[1][0];
                      $("#scan_result").find(".unfinish"+i).remove();  
                        var tr='<tr><th>'+task_id[i]+'</th><th>'+task_status[2]+'</th><th>'+task_status[0]+'</th><th><a data="'+task_id[i]+'" href="result/'+task_id[i]+'" style="color:green">查看</a></th></tr>';
                        $("#resulist").append(tr);
                        state[task_id[i]]=task_status[0];
                    }
                    
                },
                error:function () {
                    alert('ajax get_mods request error');
                }

            }
        )
        }
    }
   }
   $(document).ready(function(){
    show_result();
    interval1=setInterval("show_unfinish_result()",3000);
   });
</script>
<script>
    

</script>
</body>
</html>