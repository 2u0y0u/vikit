<div id="modules">
    <ul id="modules_ul"></ul>
</div>
<button id="start">start</button>

<script type="text/javascript">

     function ajax_get_mods() {
        $.ajax(
            {
                url: "{{ url_for('get_available_module') }}",
                success: function (result) {
                    //add li to ul
                    show_modules(result);
                },
                error:function () {
                    alert('ajax request error');
                }

            }
        )
    }

    function show_modules(result) {
        var mod_list = jQuery.parseJSON(result)
        //delete the old li
        $("#modules_ul").empty();
        //add new li (need to be handle later)
        for (var i = 0; i < mod_list.length; i++) {
            $("#modules_ul").append('<li>' + mod_list[i] + '</li>')
        }
    }

    var state='offline';

    function ajax_start_proxy(){
         $.ajax(
            {
                url: "{{ url_for('start') }}",
                async:false,
                success: function (result) {
                    if(result == 'success')
                        state='on';
                },
                error:function () {
                    alert('ajax start request failed');
                }

            }
        )
    }

    var interval_id
    $("#start").click(function () {
            if ($(this).text() == 'start') {
                //start the proxy
                ajax_start_proxy();
                alert(state);
                if (state=='on')
                {
                    ajax_get_mods();
                    //set interval
                    interval_id= setInterval("ajax_get_mods()", 3000);
                    //set text to stop
                    $(this).text('stop');
                }
                else{
                    alert('start proxy failed');
                }
            }
            else {//stop option
                //clear interval
                clearInterval(interval_id)
		state='offline';
                $(this).text('start');
            }
        }
    );
    

    function show_help(result) {
        temp_json_obj=jQuery.parseJSON(result);
        module_help=temp_json_obj['module_help'];
        module_name=temp_json_obj['module_name'];
        $('#module_help').text(module_help);
        $('#module_help_name').text(module_name);
    }
    //add click event to li according their module_name and partly refresh the page of help and form
    $("#modules_ul").on('click','li',function(){
        //set help
        $.ajax(
            {
                url: "/select_module/"+$(this).text(),
                success: function (result) {
                    //add li to ul
                    show_help(result);
                },
                error:function () {
                    alert('ajax request error');
                }

            }
        )
        //generate a form to append after help
        $("#module_form").empty();
        form_str='<form action="/execute" method="post" name="mod_input">'+'<p>module:<input type="text" name="module" value="'+$(this).text()+'" /></p>'+'<p>Target: <input type="text" name="target" /></p>'+'<p>payload: <input type="text" name="payload" /></p>'+'<p>config: <input type="text" name="config" /></p>'+'<p>config format: {"param1":"str1","param2":"str2"}</p>'+'<p>offline:<input type="text" name="offline" value="1"/></p>'+'<input type="submit" value="Submit" />';
        $("#module_form").append(form_str);

    });                                                                                                                                                                          </script>
